id: taxi_data
namespace: datatalks.de_zoomcamp

description: |
  One task to avoid problem in reperorties 

inputs:
  - id: taxi
    type: SELECT
    displayName: Select taxi type
    values: [ yellow, green ]
    defaults: yellow

  - id: year
    type: STRING
    defaults: "2020"
    description: Year (2019, 2020, 2021)

  - id: month
    type: STRING
    defaults: "01"
    description: Month (01-12)

variables:
  file: "{{inputs.taxi}}_tripdata_{{inputs.year}}-{{inputs.month}}.csv"

tasks:
  - id: process
    type: io.kestra.plugin.scripts.shell.Commands
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - |
        echo "========================================="
        echo "Processing {{inputs.taxi}} taxi data"
        echo "Date: {{inputs.year}}-{{inputs.month}}"
        echo "========================================="
        echo ""

        # Download
        echo "Downloading..."
        wget -q --show-progress https://github.com/DataTalksClub/nyc-tlc-data/releases/download/{{inputs.taxi}}/{{render(vars.file)}}.gz

        # Extract
        echo ""
        echo "Extracting..."
        gunzip {{render(vars.file)}}.gz

        # Verify file exists
        if [ ! -f "{{render(vars.file)}}" ]; then
          echo "ERROR: File not found!"
          exit 1
        fi

        echo ""
        echo "========================================="
        echo "         HOMEWORK ANSWERS"
        echo "========================================="
        echo ""
        echo "Taxi Type: {{inputs.taxi}}"
        echo "Year-Month: {{inputs.year}}-{{inputs.month}}"
        echo "Filename: {{render(vars.file)}}"
        echo ""

        # Question 1: File size
        echo "--- Question 1: File Size ---"
        ls -lh "{{render(vars.file)}}"
        SIZE=$(ls -lh "{{render(vars.file)}}" | awk '{print $5}')
        echo ""
        echo "âœ“ FILE SIZE: $SIZE"
        echo ""

        # Questions 3, 4, 5: Row count
        echo "--- Questions 3, 4, 5: Row Count ---"
        TOTAL_LINES=$(wc -l < "{{render(vars.file)}}")
        DATA_ROWS=$((TOTAL_LINES - 1))

        echo "Total lines (with header): $TOTAL_LINES"
        echo "Data rows (without header): $DATA_ROWS"
        echo ""
        echo "TOTAL ROWS: $DATA_ROWS"
        echo ""


        echo "========================================="
        echo "Taxi: {{inputs.taxi}}"
        echo "Date: {{inputs.year}}-{{inputs.month}}"
        echo "File: {{render(vars.file)}}"
        echo "Size: $SIZE"
        echo "Rows: $DATA_ROWS"
        echo "========================================="
